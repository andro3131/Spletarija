<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Admin Panel — Spletarije</title>
    <link rel="icon" type="image/png" href="/assets/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #111118;
            --bg-card: #16161f;
            --bg-card-hover: #1c1c28;
            --text-primary: #f0ede6;
            --text-secondary: #8a8a9a;
            --text-muted: #55556a;
            --accent-1: #ff6b35;
            --accent-2: #e84a5f;
            --accent-3: #a855f7;
            --accent-gradient: linear-gradient(135deg, #ff6b35, #e84a5f, #a855f7);
            --border: rgba(255,255,255,0.08);
            --radius: 12px;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* ===== LOGIN ===== */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
        }

        .login-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 3rem;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-box h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-box p { color: var(--text-secondary); margin-bottom: 2rem; font-size: 0.9rem; }

        .login-error {
            background: rgba(239,68,68,0.1);
            border: 1px solid rgba(239,68,68,0.3);
            color: #ef4444;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            display: none;
        }

        /* ===== INPUTS ===== */
        input, textarea, select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-1);
        }

        textarea { resize: vertical; min-height: 80px; }

        label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.4rem;
            font-weight: 500;
        }

        .field { margin-bottom: 1rem; }

        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent-gradient);
            color: white;
        }

        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .btn-danger {
            background: rgba(239,68,68,0.15);
            color: #ef4444;
            border: 1px solid rgba(239,68,68,0.3);
        }

        .btn-danger:hover { background: rgba(239,68,68,0.25); }

        .btn-add {
            background: rgba(255,255,255,0.05);
            color: var(--text-secondary);
            border: 1px dashed var(--border);
            width: 100%;
            justify-content: center;
            padding: 1rem;
        }

        .btn-add:hover { border-color: var(--accent-1); color: var(--accent-1); }

        /* ===== LAYOUT ===== */
        .admin-layout {
            display: none;
            min-height: 100vh;
        }

        .admin-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 2rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .admin-header h1 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .admin-header h1 span {
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .btn-logout {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }

        .btn-logout:hover { color: var(--text-primary); border-color: var(--text-muted); }

        .admin-body {
            display: flex;
            min-height: calc(100vh - 57px);
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 220px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            padding: 1rem 0;
            flex-shrink: 0;
        }

        .sidebar-item {
            display: block;
            width: 100%;
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.9rem;
            text-align: left;
            cursor: pointer;
            transition: all 0.15s;
        }

        .sidebar-item:hover { color: var(--text-primary); background: rgba(255,255,255,0.03); }

        .sidebar-item.active {
            color: var(--accent-1);
            background: rgba(255,107,53,0.08);
            border-right: 2px solid var(--accent-1);
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            padding: 2rem 3rem;
            max-width: 800px;
        }

        .section-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .section-header h2 { font-size: 1.3rem; font-weight: 600; }
        .section-header p { color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.3rem; }

        /* ===== ITEM CARDS ===== */
        .item-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .item-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .item-card-header h3 {
            font-size: 0.95rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* ===== TOAST ===== */
        .toast {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 1000;
            transform: translateX(120%);
            transition: transform 0.3s ease;
        }

        .toast.visible { transform: translateX(0); }
        .toast.success { background: rgba(34,197,94,0.15); border: 1px solid rgba(34,197,94,0.3); color: #22c55e; }
        .toast.error { background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.3); color: #ef4444; }
        .toast.warning { background: rgba(234,179,8,0.15); border: 1px solid rgba(234,179,8,0.3); color: #eab308; }

        /* ===== SAVE BAR ===== */
        .save-bar {
            position: sticky;
            bottom: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                display: flex;
                overflow-x: auto;
                border-right: none;
                border-bottom: 1px solid var(--border);
                padding: 0;
            }
            .sidebar-item {
                white-space: nowrap;
                padding: 0.75rem 1rem;
                border-right: none;
            }
            .sidebar-item.active { border-right: none; border-bottom: 2px solid var(--accent-1); }
            .admin-body { flex-direction: column; }
            .main-content { padding: 1.5rem; }
        }
    </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div class="login-screen" id="loginScreen">
    <div class="login-box">
        <h1>Spletarije Admin</h1>
        <p>Prijavite se za urejanje vsebine</p>
        <div class="login-error" id="loginError"></div>
        <form id="loginForm">
            <div class="field">
                <input type="password" id="loginPassword" placeholder="Vnesite geslo" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width:100%">Prijava</button>
        </form>
    </div>
</div>

<!-- ADMIN PANEL -->
<div class="admin-layout" id="adminLayout">
    <header class="admin-header">
        <h1><span>Spletarije</span> Admin</h1>
        <button class="btn btn-logout" onclick="logout()">Odjava</button>
    </header>

    <div class="admin-body">
        <nav class="sidebar" id="sidebar"></nav>
        <div class="main-content">
            <div class="section-header" id="sectionHeader"></div>
            <div id="formContainer"></div>
            <div class="save-bar">
                <button class="btn btn-primary" id="saveBtn" onclick="saveCurrentSection()">Shrani spremembe</button>
            </div>
        </div>
    </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ===== STATE =====
let token = sessionStorage.getItem('admin_token');
let currentSection = 'general';
let sectionData = {};

const SECTIONS = [
    { key: 'general', label: 'Splošno', description: 'Kontaktni podatki, družabna omrežja, noga strani' },
    { key: 'hero', label: 'Hero', description: 'Glavni naslov, opis in gumbi na vrhu strani' },
    { key: 'services', label: 'Storitve', description: 'Storitvene kartice in naslov sekcije' },
    { key: 'projects', label: 'Projekti', description: 'Projektne kartice s slikami' },
    { key: 'stats', label: 'Statistika', description: 'Številke in oznake statistike' },
    { key: 'process', label: 'Proces', description: 'Koraki delovnega procesa' },
    { key: 'testimonials', label: 'Mnenja', description: 'Mnenja in pričevanja strank' }
];

// ===== INIT =====
document.addEventListener('DOMContentLoaded', () => {
    if (token) {
        checkAuth();
    }
    buildSidebar();

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await login(document.getElementById('loginPassword').value);
    });
});

async function checkAuth() {
    try {
        const res = await fetch('/api/content?section=general', {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        if (res.ok) {
            showAdmin();
        } else {
            sessionStorage.removeItem('admin_token');
            token = null;
        }
    } catch {
        sessionStorage.removeItem('admin_token');
        token = null;
    }
}

// ===== AUTH =====
async function login(password) {
    const errorEl = document.getElementById('loginError');
    errorEl.style.display = 'none';

    try {
        const res = await fetch('/api/auth', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password })
        });
        const data = await res.json();

        if (res.ok) {
            token = data.token;
            sessionStorage.setItem('admin_token', token);
            showAdmin();
        } else {
            errorEl.textContent = data.error || 'Napaka pri prijavi';
            errorEl.style.display = 'block';
        }
    } catch {
        errorEl.textContent = 'Napaka pri povezavi s strežnikom';
        errorEl.style.display = 'block';
    }
}

function logout() {
    sessionStorage.removeItem('admin_token');
    token = null;
    sectionData = {};
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('adminLayout').style.display = 'none';
    document.getElementById('loginPassword').value = '';
}

function showAdmin() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('adminLayout').style.display = 'block';
    switchSection('general');
}

// ===== SIDEBAR =====
function buildSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.innerHTML = SECTIONS.map(s =>
        `<button class="sidebar-item" data-section="${s.key}" onclick="switchSection('${s.key}')">${s.label}</button>`
    ).join('');
}

async function switchSection(key) {
    currentSection = key;

    // Update sidebar active state
    document.querySelectorAll('.sidebar-item').forEach(el => {
        el.classList.toggle('active', el.dataset.section === key);
    });

    const section = SECTIONS.find(s => s.key === key);
    document.getElementById('sectionHeader').innerHTML = `<h2>${section.label}</h2><p>${section.description}</p>`;

    // Load data if not cached
    if (!sectionData[key]) {
        document.getElementById('formContainer').innerHTML = '<p style="color:var(--text-muted)">Nalagam...</p>';
        await loadSection(key);
    }

    renderForm(key);
}

async function loadSection(key) {
    try {
        const res = await fetch('/api/content?section=' + key, {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        if (res.status === 401) { logout(); return; }
        const result = await res.json();
        sectionData[key] = { data: result.data, sha: result.sha };
    } catch (err) {
        showToast('Napaka pri nalaganju: ' + err.message, 'error');
    }
}

// ===== SAVE =====
async function saveCurrentSection() {
    const btn = document.getElementById('saveBtn');
    btn.disabled = true;
    btn.textContent = 'Shranjujem...';

    const newData = collectFormData(currentSection);

    try {
        const res = await fetch('/api/content?section=' + currentSection, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({
                data: newData,
                sha: sectionData[currentSection].sha
            })
        });

        const result = await res.json();

        if (res.ok) {
            sectionData[currentSection] = { data: newData, sha: result.sha };
            showToast('Spremembe shranjene! Stran se posodobi v ~30 sekundah.', 'success');
        } else if (res.status === 409) {
            showToast('Vsebina je bila spremenjena. Osvežujem...', 'warning');
            delete sectionData[currentSection];
            await switchSection(currentSection);
        } else {
            showToast('Napaka: ' + (result.error || 'Neznana napaka'), 'error');
        }
    } catch (err) {
        showToast('Napaka pri shranjevanju: ' + err.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Shrani spremembe';
    }
}

// ===== TOAST =====
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast ' + type;
    setTimeout(() => toast.classList.add('visible'), 10);
    setTimeout(() => toast.classList.remove('visible'), 4000);
}

// ===== FORM RENDERING =====
function renderForm(key) {
    const container = document.getElementById('formContainer');
    const data = sectionData[key]?.data;
    if (!data) { container.innerHTML = ''; return; }

    switch (key) {
        case 'general': container.innerHTML = renderGeneral(data); break;
        case 'hero': container.innerHTML = renderHero(data); break;
        case 'services': container.innerHTML = renderServices(data); break;
        case 'projects': container.innerHTML = renderProjects(data); break;
        case 'stats': container.innerHTML = renderStats(data); break;
        case 'process': container.innerHTML = renderProcess(data); break;
        case 'testimonials': container.innerHTML = renderTestimonials(data); break;
    }
}

function field(name, label, value, type = 'text') {
    const escaped = String(value ?? '').replace(/"/g, '&quot;').replace(/</g, '&lt;');
    if (type === 'textarea') {
        return `<div class="field"><label>${label}</label><textarea data-field="${name}">${String(value ?? '').replace(/</g, '&lt;')}</textarea></div>`;
    }
    return `<div class="field"><label>${label}</label><input type="${type}" data-field="${name}" value="${escaped}"></div>`;
}

function renderGeneral(d) {
    return `
        ${field('companyName', 'Ime podjetja', d.companyName)}
        ${field('tagline', 'Slogan', d.tagline)}
        ${field('phone', 'Telefon (prikazano)', d.phone)}
        ${field('phoneLink', 'Telefonska povezava', d.phoneLink)}
        ${field('email', 'Email', d.email, 'email')}
        ${field('address.line1', 'Naslov — vrstica 1', d.address?.line1)}
        ${field('address.line2', 'Naslov — vrstica 2', d.address?.line2)}
        ${field('workingHours', 'Delovni \u010das', d.workingHours)}
        ${field('workingHoursNote', 'Opomba delovnega \u010dasa', d.workingHoursNote)}
        ${field('socials.facebook', 'Facebook URL', d.socials?.facebook, 'url')}
        ${field('socials.instagram', 'Instagram URL', d.socials?.instagram, 'url')}
        ${field('footerDescription', 'Opis v nogi strani', d.footerDescription, 'textarea')}
        ${field('copyright', 'Avtorske pravice', d.copyright)}
    `;
}

function renderHero(d) {
    return `
        ${field('label', 'Oznaka', d.label)}
        ${field('titleLine1', 'Naslov — vrstica 1', d.titleLine1)}
        ${field('titleLine2', 'Naslov — vrstica 2 (gradient)', d.titleLine2)}
        ${field('titleLine3', 'Naslov — vrstica 3 (oris)', d.titleLine3)}
        ${field('description', 'Opis', d.description, 'textarea')}
        ${field('ctaPrimary', 'Primarni gumb', d.ctaPrimary)}
        ${field('ctaSecondary', 'Sekundarni gumb', d.ctaSecondary)}
    `;
}

function renderServices(d) {
    let html = `
        ${field('sectionLabel', 'Oznaka sekcije', d.sectionLabel)}
        ${field('sectionTitle', 'Naslov sekcije', d.sectionTitle)}
        ${field('sectionTitleGradient', 'Naslov (gradient del)', d.sectionTitleGradient)}
        ${field('sectionSubtitle', 'Podnaslov', d.sectionSubtitle, 'textarea')}
    `;
    d.items.forEach((item, i) => {
        html += `
            <div class="item-card">
                <div class="item-card-header"><h3>Storitev ${i + 1}</h3></div>
                ${field('items.' + i + '.number', '\u0160tevilka', item.number)}
                ${field('items.' + i + '.title', 'Naslov', item.title)}
                ${field('items.' + i + '.description', 'Opis', item.description, 'textarea')}
            </div>
        `;
    });
    return html;
}

function renderProjects(d) {
    let html = `
        ${field('sectionLabel', 'Oznaka sekcije', d.sectionLabel)}
        ${field('sectionTitle', 'Naslov sekcije', d.sectionTitle)}
        ${field('sectionTitleGradient', 'Naslov (gradient del)', d.sectionTitleGradient)}
        <div id="projectsList">
    `;
    d.items.forEach((item, i) => {
        html += renderProjectCard(item, i);
    });
    html += `</div><button class="btn btn-add" onclick="addProject()">+ Dodaj projekt</button>`;
    return html;
}

function renderProjectCard(item, i) {
    return `
        <div class="item-card" data-item-index="${i}">
            <div class="item-card-header">
                <h3>Projekt ${i + 1}</h3>
                <button class="btn btn-danger" onclick="removeItem('projectsList', this)" style="font-size:0.8rem;padding:0.4rem 0.8rem">Odstrani</button>
            </div>
            ${field('items.' + i + '.tag', 'Oznaka', item.tag)}
            ${field('items.' + i + '.title', 'Naslov', item.title)}
            ${field('items.' + i + '.description', 'Opis', item.description, 'textarea')}
            ${field('items.' + i + '.image', 'URL slike', item.image, 'url')}
        </div>
    `;
}

function renderStats(d) {
    let html = '';
    d.items.forEach((item, i) => {
        html += `
            <div class="item-card">
                <div class="item-card-header"><h3>Statistika ${i + 1}</h3></div>
                ${field('items.' + i + '.target', 'Ciljna \u0161tevilka', item.target, 'number')}
                ${field('items.' + i + '.suffix', 'Pripona', item.suffix)}
                ${field('items.' + i + '.label', 'Oznaka', item.label)}
            </div>
        `;
    });
    return html;
}

function renderProcess(d) {
    let html = `
        ${field('sectionLabel', 'Oznaka sekcije', d.sectionLabel)}
        ${field('sectionTitle', 'Naslov sekcije', d.sectionTitle)}
        ${field('sectionTitleGradient', 'Naslov (gradient del)', d.sectionTitleGradient)}
    `;
    d.items.forEach((item, i) => {
        html += `
            <div class="item-card">
                <div class="item-card-header"><h3>Korak ${i + 1}</h3></div>
                ${field('items.' + i + '.number', '\u0160tevilka', item.number)}
                ${field('items.' + i + '.title', 'Naslov', item.title)}
                ${field('items.' + i + '.description', 'Opis', item.description, 'textarea')}
            </div>
        `;
    });
    return html;
}

function renderTestimonials(d) {
    let html = `
        ${field('sectionLabel', 'Oznaka sekcije', d.sectionLabel)}
        ${field('sectionTitle', 'Naslov sekcije', d.sectionTitle)}
        ${field('sectionTitleGradient', 'Naslov (gradient del)', d.sectionTitleGradient)}
        <div id="testimonialsList">
    `;
    d.items.forEach((item, i) => {
        html += renderTestimonialCard(item, i);
    });
    html += `</div><button class="btn btn-add" onclick="addTestimonial()">+ Dodaj mnenje</button>`;
    return html;
}

function renderTestimonialCard(item, i) {
    return `
        <div class="item-card" data-item-index="${i}">
            <div class="item-card-header">
                <h3>Mnenje ${i + 1}</h3>
                <button class="btn btn-danger" onclick="removeItem('testimonialsList', this)" style="font-size:0.8rem;padding:0.4rem 0.8rem">Odstrani</button>
            </div>
            ${field('items.' + i + '.quote', 'Citat', item.quote, 'textarea')}
            ${field('items.' + i + '.initials', 'Inicialke', item.initials)}
            ${field('items.' + i + '.name', 'Ime', item.name)}
            ${field('items.' + i + '.role', 'Vloga', item.role)}
        </div>
    `;
}

// ===== ADD / REMOVE ITEMS =====
function addProject() {
    const list = document.getElementById('projectsList');
    const cards = list.querySelectorAll('.item-card');
    const i = cards.length;
    const div = document.createElement('div');
    div.innerHTML = renderProjectCard({ tag: '', title: '', description: '', image: '' }, i);
    list.appendChild(div.firstElementChild);
}

function addTestimonial() {
    const list = document.getElementById('testimonialsList');
    const cards = list.querySelectorAll('.item-card');
    const i = cards.length;
    const div = document.createElement('div');
    div.innerHTML = renderTestimonialCard({ quote: '', initials: '', name: '', role: '' }, i);
    list.appendChild(div.firstElementChild);
}

function removeItem(listId, btn) {
    const list = document.getElementById(listId);
    const cards = list.querySelectorAll('.item-card');
    if (cards.length <= 1) {
        showToast('Vsaj en element mora ostati', 'warning');
        return;
    }
    btn.closest('.item-card').remove();
    // Re-index data-field attributes
    reindexItems(listId);
}

function reindexItems(listId) {
    const list = document.getElementById(listId);
    list.querySelectorAll('.item-card').forEach((card, i) => {
        card.dataset.itemIndex = i;
        card.querySelector('h3').textContent =
            listId === 'projectsList' ? `Projekt ${i + 1}` : `Mnenje ${i + 1}`;
        card.querySelectorAll('[data-field]').forEach(input => {
            const oldField = input.dataset.field;
            // Replace items.X. with items.{newIndex}.
            input.dataset.field = oldField.replace(/items\.\d+\./, `items.${i}.`);
        });
    });
}

// ===== COLLECT FORM DATA =====
function collectFormData(key) {
    const container = document.getElementById('formContainer');
    const inputs = container.querySelectorAll('[data-field]');
    const result = {};

    inputs.forEach(input => {
        const path = input.dataset.field;
        const value = input.tagName === 'TEXTAREA' ? input.value : input.value;
        setNestedValue(result, path, input.type === 'number' ? Number(value) : value);
    });

    return result;
}

function setNestedValue(obj, path, value) {
    const parts = path.split('.');
    let current = obj;

    for (let i = 0; i < parts.length - 1; i++) {
        const part = parts[i];
        const nextPart = parts[i + 1];

        if (!(part in current)) {
            current[part] = /^\d+$/.test(nextPart) ? [] : {};
        }

        current = current[part];
    }

    current[parts[parts.length - 1]] = value;
}
</script>
</body>
</html>
